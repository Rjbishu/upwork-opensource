<?phpclass Invoicehourly extends CI_Model {    function __construct() {        parent::__construct();    }    function check($permission) {        if ($this->Adminlogincheck->checkper($permission['invoicehourly'])) {            return true;        } else {            redirect(site_url());            exit();        }    }    function load($permission, $mod) {        $page = $this->uri->uri_to_assoc();        $title = $this->Adminforms->getdata("name", "usersubpage", $permission['invoicehourly']);        if (isset($_GET['q'])) {            $q = $_GET['q'];        } else {            $q = false;        }        $this->db->select('*');        $this->db->from('webuser');        $this->db->where('webuser.webuser_type', '1');        $this->db->where('webuser.isactive', 1);        $this->db->where('webuser.isdelete', 0);        $query = $this->db->get();        $result = $query->result();        $this->db->select('*');        $this->db->from('daily_hourly_invoice');        $query = $this->db->get();        $workdairy = $query->result();        $this->db->select('*');        $this->db->from('billingmethodlist');        $this->db->where('billingmethodlist.belongsTo', $user_id);        $this->db->where('billingmethodlist.isPrimary', "1");        $resultMethods = $this->db->get()->result();        foreach ($workdairy as $failedInvoice) {            $chargeUser = chargePrimary($user_id, $amount);            if ($chargeUser['status_code'] == 1) {                //doing nothing            } else {                $transdata['contract_id'] = $failedInvoice->contract_id;                $transdata['fuser_id'] = $failedInvoice->fuser_id;                $transdata['cuser_id'] = $failedInvoice->cuser_id;                $transdata['trans_through'] = $resultMethods->paymentMethod;                $transdata['transaction_id'] = $chargeUser['transaction_id'];                $transdata['status'] = "Processed";                $transdata['currency'] = "";                $transdata['amount'] = $failedInvoice->amount;                $transdata['des'] = $failedInvoice->des;                $transdata['date'] = $failedInvoice->date;                $this->db->insert('daily_hourly_transaction', $transdata);                $this->db->where('id_daily_hourly_invoice', $failedInvoice->id_daily_hourly_invoice);                $this->db->delete('daily_hourly_invoice');                                //check if this user has more failed invoices                $this->db->select('*');                $this->db->from('daily_hourly_invoice');                $this->db->where('cuser_id', $failedInvoice->cuser_id);                $query = $this->db->get();                $suspendids = $query->result();                if (empty($suspendids)) {                    $user_data['isactive'] = 1;                    $user_data['suspend_reason'] = 0;                    $this->db->where('webuser_id', $failedInvoice->cuser_id);                    $this->db->update('webuser', $user_data);                }            }        }        $data = array('title' => $title, 'permission' => $permission, 'loadpage' => $page['loadpage'], 'subpage' => $page['subpage'], 'result' => $result,);        $this->Admintheme->loadview($page['loadpage'] . "/" . $page['subpage'], $data);    }}?>